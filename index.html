<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle da Porta IoT</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>

    <style>
        body, html { height: 100%; }
        body { display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; }
    </style>
</head>
<body class="p-3">

    <div class="container" style="max-width: 500px;">
        <div class="card shadow-sm">
            <div class="card-body p-4 p-md-5">
                <h2 class="card-title text-center mb-4">Controle da Trava IoT</h2>
                
                <div class="text-center mb-4">
                    <span id="statusBadge" class="badge fs-6 p-2 bg-secondary">
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Verificando...
                    </span>
                </div>

                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="inputSenha" placeholder="Senha">
                    <label for="inputSenha">Senha de Acesso</label>
                </div>
                
                <div id="alertArea" class="mb-3"></div>

                <div class="d-grid gap-3">
                    <button id="btnAbrir" class="btn btn-success btn-lg p-3">
                        <span id="spinnerAbrir" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                        <i id="iconAbrir" class="bi bi-unlock-fill me-2"></i> 
                        ABRIR TRAVA
                    </button>
                    <button id="btnFechar" class="btn btn-danger btn-lg p-3">
                        <span id="spinnerFechar" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                        <i id="iconFechar" class="bi bi-lock-fill me-2"></i> 
                        FECHAR TRAVA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configurações ---
        const MQTT_BROKER_WS = "wss://broker.hivemq.com:8884/mqtt";
        const COMANDO_TOPIC = "senai/iot/porta/comando"; // Para enviar
        const STATUS_TOPIC = "senai/iot/porta/status";   // Para receber

        // --- Elementos da Página ---
        const btnAbrir = document.getElementById("btnAbrir");
        const btnFechar = document.getElementById("btnFechar");
        const statusBadge = document.getElementById("statusBadge");
        const inputSenha = document.getElementById("inputSenha"); // Pega o input da senha
        const alertArea = document.getElementById("alertArea"); // Pega a área de alerta

        // Elementos dos spinners e ícones
        const spinnerAbrir = document.getElementById("spinnerAbrir");
        const iconAbrir = document.getElementById("iconAbrir");
        const spinnerFechar = document.getElementById("spinnerFechar");
        const iconFechar = document.getElementById("iconFechar");

        // --- Conexão MQTT ---
        const client = mqtt.connect(MQTT_BROKER_WS);

        client.on("connect", () => {
            console.log("Conectado ao MQTT (Web)");
            client.subscribe(STATUS_TOPIC);
        });

        // --- Lógica 1: Enviando Comandos ---
        btnAbrir.addEventListener("click", () => {
            enviarComando("abrir");
        });

        btnFechar.addEventListener("click", () => {
            enviarComando("fechar");
        });

        function enviarComando(comando) {
            limparAlerta(); // Limpa alertas antigos
            const senhaDigitada = inputSenha.value;

            // Validação simples no front-end
            if (senhaDigitada.length === 0) {
                mostrarAlerta("Por favor, digite a senha.", "warning");
                return;
            }

            // NOVO: Payload agora inclui a senha
            const payload = JSON.stringify({ 
                comando: comando, 
                senha: senhaDigitada 
            });

            console.log(`Enviando comando: ${comando}`);
            client.publish(COMANDO_TOPIC, payload);
            mostrarSpinner(comando);
        }

        // --- Lógica 2: Recebendo Status ---
        client.on("message", (topic, message) => {
            if (topic === STATUS_TOPIC) {
                try {
                    const data = JSON.parse(message.toString());
                    console.log("Status recebido:", data);
                    atualizarStatusUI(data.status); // Chama a função que atualiza a tela
                } catch(e) { console.error(e); }
            }
        });

        // --- Funções Auxiliares de UI ---
        
        function atualizarStatusUI(status) {
            pararSpinners(); // Para os spinners independentemente do resultado
            
            if (status === "aberta") {
                statusBadge.textContent = "Aberta";
                statusBadge.className = "badge fs-6 p-2 bg-success";
                limparAlerta();
            } else if (status === "fechada") {
                statusBadge.textContent = "Trancada";
                statusBadge.className = "badge fs-6 p-2 bg-danger";
                limparAlerta();
            } else if (status === "senha_invalida") {
                // NOVO: Trata a resposta de senha inválida
                mostrarAlerta("Senha inválida!", "danger");
                inputSenha.focus(); // Coloca o cursor de volta no campo da senha
            }
        }

        function mostrarAlerta(mensagem, tipo = "danger") {
            alertArea.innerHTML = `<div class="alert alert-${tipo}" role="alert">${mensagem}</div>`;
        }
        
        function limparAlerta() {
            alertArea.innerHTML = "";
        }
        
        function mostrarSpinner(comando) {
            btnAbrir.disabled = true;
            btnFechar.disabled = true;
            if(comando === 'abrir') {
                spinnerAbrir.classList.remove('d-none');
                iconAbrir.classList.add('d-none');
            } else {
                spinnerFechar.classList.remove('d-none');
                iconFechar.classList.add('d-none');
            }
        }
        
        function pararSpinners() {
            btnAbrir.disabled = false;
            btnFechar.disabled = false;
            spinnerAbrir.classList.add('d-none');
            spinnerFechar.classList.add('d-none');
            iconAbrir.classList.remove('d-none');
            iconFechar.classList.remove('d-none');
        }
    </script>
</body>
</html>